---
layout: default
title: 토스의 인프라 모니터링
parent: 토스 기술 분석 Toss Tech
nav_order: 2
last_modified_date: 2021-03-07 07:51:00
last_modified_at: 2021-03-07 07:51:00
---

# 토스의 인프라 모니터링
{: .no_toc }

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

이 포스트는 [토스ㅣSLASH 21 - 토스의 서버 인프라 모니터링](https://www.youtube.com/watch?v=rxurfKT2lD8) 유튜브 영상을 참고하여 본인의 의견이 첨가된 내용으로 포스팅을 **재구성한** 글임을 미리 밝혀 둡니다. 만약 토스 관계자분께서 해당 포스팅의 게재를 원치 않으시거나 수정이 필요하다고 판단되면 이메일로 연락 부탁드립니다.

본 내용은 **kubernetes**, **Istio** 에 대한 지식이 없다면 이해하기 힘들 수 있습니다. 본 포스팅에서 해당 개념을 따로 설명을 드리지 않습니다.

## 개요

토스의 서버 인프라는 **2019년에 대대적인 변화**가 있었는데, 그 당시 컨테이너 기반의 오케스트레이션 시스템으로 **vamp, DC/OS** 기반의 인프라를 사용하였다. DC/OS는 컨테이너 오케스트레이션 엔진이고, vamp는 마이크로 서비스에서 서비스 디스커버리를 담당하는 API Gateway 컴포넌트이다. 하지만 운영 한계를 느껴 엔진을 변경하게 되었다고 소개하고 있다.

이후 **kubernetes, Istio** 기반으로 마이그레이션 하게 되는데, kubernetes는 잘 아시다시피 컨테이너 오케스트레이션이고 Istio는 쿠버네티스 클러스터에서 컨테이너의 연결, 모니터 및 보안을 구성하는 메시 서비스이다.

엔진의 변화 외에도 모니터링 시스템에도 변화가 있었는데, 기존에는 **influxdb, telegraf** 으로 모니터링을 진행했다고 한다. 그러나 엔진을 쿠버네티스로 변경하면서 좀더 친화적인 **prometheus, thanos** 으로 변경하게 된다.

오류가 발생했을때 로그를 보고 문제 원인을 발견할 때도 있으나 로직이 복잡하거나 트랜잭션이 길 경우 파악이 잘 안된다. 보통 잘 동작하다가 갑자기 오류가 나는 이슈가 까다롭고 자주 겪게 된다. 이때 메트릭이 원인 규명에 도움이 된다. 소스코드 상의 오류가 아닌 외적인 요소의 오류(메모리, CPU 같은 자원 부족 및 네트워크상 오류 등)로 발생한 경우도 많이 있다.

## 메트릭 레이어 3단계

![toss_12.png](/meta/docs/architecture-analysis/toss/toss_12.png)

1. **Application Layer Metric** : 첫번째는 어플리케이션 레이어 이다. 토스의 경우 스프링 프레임워크가 대다수여서 JVM 메트릭이나 톰켓 메트릭, JPA 메트릭을 계속 모니터링 했다고 밝히고 있다. 로깅과 가장 상관관계가 높은 단계의 메트릭이기 때문에 이 레이어부터 확인하게 된다. 여기서 특이한 현상이 없으면 네트워크를 관찰하게 된다. 

2. **Network Layer Metric** : 두번째는 네트워크 레이어 이다.서비스간의 통신이 원할한지 확인 한다. 극단적인 케이스에선 요청 자체가 ingress 로 들어오지 못해 큰 장애가 날 수 있기 때문에 모든 네트워크 퍼널이 정상적인지 알려줄 가시성도 확보해야 한다.

3. **OS Layer Metric** : 세번째로는 OS 레아어 이다. 서버의 리소스가 얼마나 잘 분배되거나 부족한건지 그리고 에러가 발생하는지 판단할 수 있도록 하는 지표이다. 해당 지표는 로깅과 트레이싱을 확인해 봤을 때 가장 상관관계가 낮기 때문에 마지막에 판단할 근거를 제시하게 해 준다.

영상의 주 목적은 인프라 단계의 모니터링이기 때문에 Network Layer 와 OS Layer 에서 발생한 문제를 주로 어떻게 문제를 발견하고 해결 했는지 소개하고 있다.

### Network Layer Metric

![toss_13.png](/meta/docs/architecture-analysis/toss/toss_13.png)
